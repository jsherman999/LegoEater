# API Keys and iOS Setup Guide

Last verified: February 12, 2026.

This guide explains:
- how to get all keys used by LegoEater
- how to configure `.env`
- how to run the app on iPhone/iOS (including camera/scanner requirements)

## 1) Required Environment Variables

Set these in `/Users/jay/lego/.env`.

```dotenv
REBRICKABLE_API_KEY=
BRICKLINK_CONSUMER_KEY=
BRICKLINK_CONSUMER_SECRET=
BRICKLINK_TOKEN_VALUE=
BRICKLINK_TOKEN_SECRET=
UPCITEMDB_KEY=
UPCITEMDB_KEY_TYPE=3scale
API_PORT=3000
WEB_PORT=5173
DATABASE_PATH=data/legoeater.db
```

## 2) Rebrickable Key

Official docs:
- [Rebrickable API docs](https://rebrickable.com/api/)
- [Rebrickable API v3 docs](https://rebrickable.com/api/v3/docs/)

Steps:
1. Create/sign in to your Rebrickable account.
2. Open your Rebrickable API key page from your account settings.
3. Copy the key into `.env` as `REBRICKABLE_API_KEY`.
4. Restart the API.

Quick test:
```bash
curl -H "Authorization: key $REBRICKABLE_API_KEY" \
  "https://rebrickable.com/api/v3/lego/sets/75192-1/"
```

## 3) BrickLink Consumer/Token Keys (OAuth 1.0)

Official docs:
- [BrickLink API overview](https://www.bricklink.com/v3/api.page?page=overview)
- [BrickLink API auth](https://www.bricklink.com/v3/api.page?page=auth)

LegoEater needs all four values:
- `BRICKLINK_CONSUMER_KEY`
- `BRICKLINK_CONSUMER_SECRET`
- `BRICKLINK_TOKEN_VALUE`
- `BRICKLINK_TOKEN_SECRET`

Steps:
1. Sign in to BrickLink.
2. In API settings, create/get your consumer key + consumer secret.
3. Register your app/client and allowed public IP(s).
4. Generate a token value + token secret.
5. Put all values in `.env`.
6. Restart the API.

Notes:
- BrickLink OAuth signatures are generated by the app automatically.
- If your ISP public IP changes, BrickLink requests may fail until you update API settings.

## 4) UPCitemdb (Barcode Lookup)

Reference:
- [UPCitemdb homepage/docs](https://www.upcitemdb.com/)

LegoEater supports both modes:
- Trial mode (no key): uses `https://api.upcitemdb.com/prod/trial/lookup`
- Paid mode (key): uses `https://api.upcitemdb.com/prod/v1/lookup` with:
  - header `user_key: <UPCITEMDB_KEY>`
  - header `key_type: <UPCITEMDB_KEY_TYPE>`

Configuration:
- Leave `UPCITEMDB_KEY` empty to use trial mode.
- Set `UPCITEMDB_KEY` (and optionally `UPCITEMDB_KEY_TYPE`) to use paid mode.

## 5) Security Notes

- Never commit `.env` to git.
- Rotate keys if they were exposed.
- Keep BrickLink secrets private; they can sign requests on your behalf.

## 6) iOS Usage (iPhone/iPad)

## 6.1 Same-LAN quick access (manual browsing)

Use this for normal browsing, inventory CRUD, and reports.

1. Connect iPhone and Mac to the same Wi-Fi.
2. Find Mac LAN IP (usually one of these):
   ```bash
   ipconfig getifaddr en0
   ipconfig getifaddr en1
   ```
3. Start API:
   ```bash
   cd /Users/jay/lego
   bun run --filter @lego/api dev
   ```
4. Start web bound to LAN with API URL pointing at the Mac IP:
   ```bash
   cd /Users/jay/lego
   VITE_API_URL=http://<MAC_LAN_IP>:3000/api bun run --filter @lego/web dev -- --host 0.0.0.0 --port 5173
   ```
5. On iPhone Safari, open:
   `http://<MAC_LAN_IP>:5173`

## 6.2 Camera/scanning on iOS (recommended: HTTPS)

Camera APIs (`getUserMedia`) require a secure context (HTTPS) in Safari.

Recommended flow:
1. Build and run single-port app:
   ```bash
   cd /Users/jay/lego
   bun run build
   bun run start
   ```
2. Expose `http://localhost:3000` through an HTTPS tunnel (for example Cloudflare Tunnel, ngrok, or equivalent).
3. Open the generated `https://...` URL on iPhone.
4. Grant camera permission when prompted.

## 6.3 Add to Home Screen (iOS)

Apple reference:
- [Apple: Save apps from Safari](https://support.apple.com/guide/iphone/save-apps-from-safari-iph42ab2f3a7/ios)

Steps:
1. Open the app URL in Safari.
2. Tap Share.
3. Tap **Add to Home Screen**.
4. Launch from home screen like a normal app shortcut.

## 7) Troubleshooting

- `REBRICKABLE_API_KEY is required`:
  - Set `REBRICKABLE_API_KEY` in `.env`, restart API.
- BrickLink 401/403:
  - Verify all four BrickLink env vars and registered IP settings.
- Barcode lookup rate-limited:
  - Trial UPCitemdb limit reached; add `UPCITEMDB_KEY` for paid mode.
- iPhone can open app but camera fails:
  - Use HTTPS origin (tunnel or local TLS).
